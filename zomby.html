<html>
    <head>
        <title>Multiplayer PACMAN</title>
    </head>
    <body>
        <script src="jquery-2.1.1.min.js"></script>
        <script src="./class/Render.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/style.css"/>
        <style>
            body{
                zoom : 0.50;
            }
            .alert{
                background-color: red;
                color: white;
                font-size: xx-large;
            }
        </style>
        <script>

            var socket  = io.connect('http://localhost:8080', { reconnect: false });
            var render  = null;
            setTimeout(function(){
                socket.emit('connection', '');
            }, Math.random() * 2000);

            // UNCHANGED
            socket.on('gameConfiguration', function(map){
                render = new Render();
                render.mapWrapperHtml = $('MapWrapper');
                render.mapHtml = $('#Map');
                render.gridHeight = map.gridHeight;
                render.gridWidth = map.gridWidth;
                render.countDownWrapperHtml = $("#CountDownWrapper");
                render.countDownMessageHtml = $("#CountDownMessage");
                render.countDownValueHtml = $("#CountDownValue");

                render.printMap();

                $('.Candy').remove();
                (map.candies).forEach(function(candie){
                    render.editCandy(candie);
                });

                $('.Player').remove();
                (map.players).forEach(function(player){
                    render.editPlayer(player);
                });
                canInterruptAtAnyTime();
            });

            // CHANGED
            socket.on('sendYourName', function(){
                socket.emit('playerName', "Zomby");
            });

            // UNCHANGED
            socket.on('candiesPositions', function(candies){
                $('.Candy').remove();
                candies.forEach(function(candie){
                    render.editCandy(candie);
                });
            });

            // UNCHANGED
            socket.on('aboutMe', function(player) {
                if (render.me === null) {
                    render.me = player;
                }
                render.editPlayer(render.me);
            });

            // UNCHANGED
            socket.on('newPlayer', function(player){
                render.editPlayer(player);
            });

            // UNCHANGED
            socket.on('playerMove', function(player){
                render.editPlayer(player);
            });

            // UNCHANGED
            socket.on('deletePlayer', function(player){
                render.deletePlayer(player);
            });

            // UNCHANGED
            socket.on('candyCaught', function(candie){
                render.editCandy(candie);
            });

            // UNCHANGED
            socket.on('playersPoints', function(players){
                players.forEach(function(player){
                    render.editScore(player);
                });
            });

            // UNCHANGED
            socket.on('gameOver', function(players){
                var winner = null;
                players.forEach(function(player){
                    render.editScore(player);
                    if(winner === null){
                        winner = player;
                    } else {
                        if(player != null && winner.score < player.score){
                            winner = player;
                        }
                    }
                });

                if(winner.id == render.me.id){
                    alert("YOU WIN, you ate : "+winner.score+" candie");
                } else {
                    alert("YOU LOOSE, you ate :"+players[render.me.id].score+" candie, the winner ate : "+winner.score);
                }
            });

            // UNCHANGED
            socket.on('candiesPosition', function(datas){
                $('.Candy').remove();
                for(var i=0 ; i<map.candies.length ; i++){
                    render.editCandy(map.candies[i], map, $('#GameMap'));
                }
            });

            // UNCHANGED
            socket.on('sendYourName', function(){
                //alert("Entrez votre nom pour jouer");
            });

            // UNCHANGED
            socket.on('gameFull', function(){
                alert("La partie est complÃ¨te");
            });

            // UNCHANGED
            socket.on('startCountdownPlayersTime', function(time){
                console.info('startCountdownPlayersTime');
                render.startCountDown("Waiting for players", time);
            });

            // CHANGED
            socket.on('startCountdownGameStartTime', function(time){
                console.info('startCountdownGameStartTime');
                render.startCountDown("Game start in", time);
                var axes = ['left', 'right', 'up', 'down'];
                setInterval(function(){
                    if(render.me != null){
                        render.me.direction = axes[Math.floor(Math.random() * 4)];
                        socket.emit('playerMove', render.me);
                    }
                }, 10);
            });

            /**
             * Function that CAN interrupt the "normal" execution within a 15s delay
             */
            function canInterruptAtAnyTime(){
                var bin         = Math.round(Math.random());
                var disconnect  = Math.floor(Math.random()*15)*1000;
                if(bin){
                    render.countDownWrapperHtml.append('<div class="alert">Will be interrupted within '+disconnect/1000+' seconds !</div>');
                    setTimeout(function(){
                        socket.disconnect();
                        render.countDownWrapperHtml.append('<p class="alert">DISCONNECTED</p>')
                    }, disconnect);
                }
            }

        </script>

        <div id="MenuWrapper">
            <form id="NameForm" action="#">
                <br/>
                <span style="color:white;font-size:18px;">Enter your name</span>
                <br/><br/>
                <input type="text" class="Input"/>
                <br/>
                <input type="submit" class="Button"/>
                <br/>
            </form>
            <table>
                <thead>
                    <tr>
                        <td>
                            <strong>Player</strong>
                        </td>
                        <td>
                            <strong>Score</strong>
                        </td>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="GameInfo"></div>
        </div>
        <div id="GameWrapper">
            <div id="MapWrapper">
                <div id="Map"></div>
            </div>
            <div id="CountDownWrapper">
                <div id="CountDownMessage"></div>
                <div id="CountDownValue"></div>
            </div>
        </div>
    </body>
</html>
