<html>
    <head>
        <title>Multiplayer PACMAN</title>
    </head>
    <body>
        <script src="jquery-2.1.1.min.js"></script>
        <script src="./class/Render.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <link rel="stylesheet" type="text/css" href="./css/style.css"/>
        <style>
            body{
                zoom : 0.65;
            }
        </style>
        <script>

            var socket 	= io.connect('http://localhost:8080', {
                    reconnect: false
                }),
                render	= new Render(),
                map		= null,
                aboutMe	= null,
                stop    = false;
            socket.emit('connection', '');

            socket.on('gameConfiguration', function(datas){
                map 	= datas;
                render 	= new Render(map, $('#GameMap'), $('GameWrapper'));
                render.printMap($('GameWrapper'), $('#GameMap'), map.squareHeight, map.squareWidth, map.squareSize, map.wrapperPadding);
                $('.Candy').remove();
                for(var i=0 ; i<map.candies.length ; i++){
                    render.editCandy(map.candies[i], map, $('#GameMap'));
                }
                $('.Player').remove();
                for(var i=0 ; i<map.players.length ; i++){
                    render.editPlayerPosition(map.players[i], map, $('#GameMap'));
                }
            });

            socket.on('sendYourName', function(){
                setTimeout(function(){
                    socket.emit('playerName', "Zomby");
                }, Math.random() * 2000);
            });

            socket.on('candiesPositions', function(datas){
                $('.Candy').remove();
                for(var i=0 ; i<datas.length ; i++){
                    render.editCandy(datas[i], map, $('#GameMap'));
                }
            });

            socket.on('aboutMe', function(datas) {
                if (aboutMe === null) {
                    aboutMe = datas;
                }
                render.editPlayerPosition(aboutMe, map, $('#GameMap'));
                insertTableLine(aboutMe);
            });

            socket.on('newPlayer', function(datas){
                render.editPlayerPosition(datas, map, $('#GameMap'));
                insertTableLine(datas);
            });

            socket.on('playerMove', function(datas){
                render.editPlayerPosition(datas, map, $('#GameMap'));
            });

            socket.on('candyCaught', function(datas){
                render.editCandy(datas, map, $('GameMap'));
            });

            socket.on('playersPoints', function(datas){
                datas.forEach(function(player){
                    editScore(player);
                });
            });

            socket.on('gameFull', function(){
                alert("La partie est complÃ¨te");
            });

            socket.on('gameOver', function(datas){
                datas.forEach(function(player){
                    editScore(player);
                });
                stop = true; var max = datas[0];
                for(var i=1 ; i<datas.length ; i++){
                    if(max.score < datas[i].score){
                        max = datas[i];
                    }
                }
                if(max.id === aboutMe.id || datas[aboutMe.id].score === max.score){
                    alert("YOU WIN, you ate : "+max.score+" candie");
                } else {
                    alert("YOU LOOSE, you ate :"+datas[aboutMe.id].score+" candie, the winner ate : "+max.score);
                }
            });

            socket.on('tenSecondsCountdown', function(time){
                console.info('Waiting for '+time+'s');
                startCountDown("Waiting for players", time);
            });

            socket.on('candiesPosition', function(datas){
                $('.Candy').remove();
                for(var i=0 ; i<map.candies.length ; i++){
                    render.editCandy(map.candies[i], map, $('#GameMap'));
                }
            });

            socket.on('readySteadyGo', function(datas){
                console.info('start in 3..2..1');
                var axes = ['left', 'right', 'up', 'down'];
                setInterval(function(){
                    if(!stop){
                        aboutMe.direction = axes[Math.floor(Math.random() * 4)];
                        socket.emit('playerMove', aboutMe);
                    }
                }, 10);
            });

            function editScore(player){
                document.querySelector('#player-'+player.id+' td.pacman').innerHTML = player.color;
                document.querySelector('#player-'+player.id+' td.score').innerHTML = player.score;
            }

            function insertTableLine(player){
                document.querySelector("table tbody").innerHTML += '<tr id="player-'+player.id+'"><td class="pacman">'+player.name+'</td><td class="score">'+player.score+'</td></tr>';
            }

        </script>

        <div id="MenuWrapper">
            <form id="NameForm" action="#">
                <br/>
                <span style="color:white;font-size:18px;">Enter your name</span>
                <br/><br/>
                <input type="text" class="Input"/>
                <br/>
                <input type="submit" class="Button"/>
                <br/>
            </form>
            <table>
                <thead>
                    <tr><td><strong>Player</strong></td><td><strong>Score</strong></td></tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <div id="GameInfo"></div>
        </div>
        <div id="GameWrapper">
            <div id="MapWrapper">
                <div id="GameMap"></div>
            </div>
            <div id="CountDownWrapper">
                <div id="CountDownMessage"></div>
                <div id="CountDownValue"></div>
            </div>
        </div>
        <script>
            var interval = null;

            function startCountDown(message, time){
                if(interval != null){
                    clearInterval(interval);
                }
                $("#CountDownWrapper").show();
                $("#CountDownMessage").html(message);
                var countDown = time;
                interval = setInterval(function() {
                    if(countDown<0){
                        clearInterval(interval);
                        $("#CountDownWrapper").hide();
                        $("#CountDownMessage").html("");
                        $("#CountDownValue").html("");
                    }else{
                        $("#CountDownValue").html(countDown);
                        countDown--;
                    }
                }, 1000);
            }

        </script>
    </body>
</html>
